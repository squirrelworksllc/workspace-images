name: publish (dockerhub)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  # 1) Build a dynamic matrix from .vscode/images.json,
  #    but ONLY include images affected by the push.
  matrix:
    name: generate publish matrix (changed images only)
    runs-on: ubuntu-latest
    outputs:
      include: ${{ steps.gen.outputs.include }}
      any: ${{ steps.gen.outputs.any }}
    steps:
      - name: Checkout (full history for diffs)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute changed files for this push
        id: changed
        shell: bash
        run: |
          set -euo pipefail

          before="${{ github.event.before }}"
          after="${{ github.sha }}"

          # If this is the first push or GitHub didn't provide a usable "before", fall back to previous commit.
          if [ -z "$before" ] || [ "$before" = "0000000000000000000000000000000000000000" ]; then
            before="$(git rev-parse "${after}^" 2>/dev/null || true)"
          fi

          if [ -z "$before" ]; then
            echo "Could not determine a 'before' commit. Defaulting to rebuild all."
            echo "files=" >> "$GITHUB_OUTPUT"
            echo "rebuild_all=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Diff range: $before..$after"
          files="$(git diff --name-only "$before" "$after" | tr '\n' ' ')"
          echo "Changed files: $files"
          echo "files=$files" >> "$GITHUB_OUTPUT"

          rebuild_all=false

          # Rebuild all if matrix/tags changed
          if echo "$files" | grep -qE '(^| )\.vscode/images\.json( |$)'; then
            rebuild_all=true
          fi

          # Rebuild all if build-context changes that can affect most images changed
          # (based on your repo layout)
          if echo "$files" | grep -qE '(^| )(\.dockerignore|common/|src/|tools/)( |$)'; then
            rebuild_all=true
          fi

          echo "rebuild_all=$rebuild_all" >> "$GITHUB_OUTPUT"

      - name: Generate include matrix from .vscode/images.json (filtered)
        id: gen
        shell: bash
        run: |
          set -euo pipefail

          files="${{ steps.changed.outputs.files }}"
          rebuild_all="${{ steps.changed.outputs.rebuild_all }}"

          # Include an image if:
          # - rebuild_all=true, OR
          # - its Dockerfile changed, OR
          # - any file under the Dockerfile directory changed
          include="$(jq -c --arg files "$files" --arg rebuild_all "$rebuild_all" '
            def tokens($s): ($s | split(" ") | map(select(length>0)));

            ($files | tokens) as $changed
            |
            def touched($dockerfile):
              ($dockerfile | split("/")[:-1] | join("/")) as $dir
              |
              any($changed[]; . == $dockerfile or (. | startswith($dir + "/")));

            if $rebuild_all == "true" then
              { include: [ .images[] | { key, dockerfile, repo, prodTag, devTarget, lintTarget } ] }
            else
              { include: [
                .images[]
                | select(touched(.dockerfile))
                | { key, dockerfile, repo, prodTag, devTarget, lintTarget }
              ] }
            end
          ' .vscode/images.json)"

          count="$(echo "$include" | jq '.include | length')"
          echo "Matrix image count: $count"
          echo "$include" | jq .

          echo "include=$include" >> "$GITHUB_OUTPUT"
          if [ "$count" -gt 0 ]; then
            echo "any=true" >> "$GITHUB_OUTPUT"
          else
            echo "any=false" >> "$GITHUB_OUTPUT"
          fi

  publish:
    name: publish (${{ matrix.key }})
    runs-on: ubuntu-latest
    needs: [matrix]
    if: needs.matrix.outputs.any == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.include) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push production image
        shell: bash
        run: |
          set -euo pipefail
          echo "Dockerfile: ${{ matrix.dockerfile }}"
          echo "Pushing:   ${{ matrix.repo }}:${{ matrix.prodTag }}"

          DOCKER_BUILDKIT=1 docker buildx build             --progress=plain             --push             -t "${{ matrix.repo }}:${{ matrix.prodTag }}"             -f "${{ matrix.dockerfile }}"             .

  nothing-to-publish:
    name: nothing to publish
    runs-on: ubuntu-latest
    needs: [matrix]
    if: needs.matrix.outputs.any != 'true'
    steps:
      - name: No changed images detected
        run: |
          echo "No image Dockerfiles (or their directories) changed in this push. Skipping Docker Hub publish."
  