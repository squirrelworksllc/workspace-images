# Main CI enforcement workflow for the repository
name: ci

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
  push:
    branches: ["main", "develop"]

permissions:
  contents: read

jobs:
  # 1) Generate the build matrix from .vscode/images.json
  matrix:
    name: generate matrix
    runs-on: ubuntu-latest
    outputs:
      include: ${{ steps.gen.outputs.include }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate include matrix
        id: gen
        shell: bash
        run: |
          set -euo pipefail

          include="$(jq -c '
            { include: [
              .images[] | {
                key,
                dockerfile,
                repo,
                prodTag,
                devTarget,
                lintTarget
              }
            ] }' .vscode/images.json)"

          echo "include=$include" >> "$GITHUB_OUTPUT"
          echo "$include" | jq .

  # 2) Lint each image
  lint:
    name: lint (${{ matrix.key }})
    runs-on: ubuntu-latest
    needs: [matrix]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.include) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run lint target
        shell: bash
        run: |
          set -euo pipefail
          echo "Dockerfile: ${{ matrix.dockerfile }}"
          DOCKER_BUILDKIT=1 docker build \
            --progress=plain \
            --no-cache \
            --target "${{ matrix.lintTarget }}" \
            -f "${{ matrix.dockerfile }}" \
            .

  # 2b) Stable required check for branch protection
  lint-gate:
    name: lint / gate
    runs-on: ubuntu-latest
    needs: [lint]
    if: always()
    steps:
      - name: Evaluate lint results
        shell: bash
        run: |
          set -euo pipefail
          echo "lint result: ${{ needs.lint.result }}"
          case "${{ needs.lint.result }}" in
            success|skipped) exit 0 ;;
            *) exit 1 ;;
          esac

  # 3) Production builds (informational)
  build-production:
    name: build production (${{ matrix.key }})
    runs-on: ubuntu-latest
    needs: [matrix]
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.include) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build production image (no push)
        shell: bash
        run: |
          set -euo pipefail
          echo "Dockerfile: ${{ matrix.dockerfile }}"
          echo "Building: ${{ matrix.repo }}:${{ matrix.prodTag }}"
          DOCKER_BUILDKIT=1 docker build \
            --progress=plain \
            -t "${{ matrix.repo }}:${{ matrix.prodTag }}" \
            -f "${{ matrix.dockerfile }}" \
            .