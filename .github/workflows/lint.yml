name: lint

on:
  pull_request:

permissions:
  contents: read

jobs:
  matrix:
    runs-on: ubuntu-latest
    outputs:
      include: ${{ steps.gen.outputs.include }}
    steps:
      - uses: actions/checkout@v4
      - id: gen
        shell: bash
        run: |
          set -euo pipefail
          include="$(jq -c '{ include: [ .images[] | { key, dockerfile, lintTarget } ] }' .vscode/images.json)"
          echo "include=$include" >> "$GITHUB_OUTPUT"

  lint:
    name: lint (${{ matrix.key }})
    runs-on: ubuntu-latest
    needs: [matrix]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.include) }}
    steps:
      - uses: actions/checkout@v4
      - shell: bash
        run: |
          set -euo pipefail
          DOCKER_BUILDKIT=1 docker build --progress=plain --no-cache \
            --target "${{ matrix.lintTarget }}" \
            -f "${{ matrix.dockerfile }}" \
            .
